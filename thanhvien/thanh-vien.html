<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Th√†nh Vi√™n | COFFEE S√¥ng H·∫≠u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="./thanhvien.css" rel="stylesheet"> 

    <style>
        /* CSS b·ªï sung ri√™ng cho trang n√†y n·∫øu c·∫ßn */
        .voucher-card { transition: all 0.2s ease; }
        .voucher-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>

<body class="bg-[#fcfcfc] text-gray-900 font-sans">

    <header class="bg-white sticky top-0 z-50 shadow-sm">
        <div class="bg-red-950 text-white text-[10px] py-2 px-8 flex justify-between uppercase font-bold tracking-widest">
            <span>Admin System</span><span>Hotline: 0852.494.694</span>
        </div>
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-black text-red-950">COFFEE<span class="text-yellow-600"> S√¥ng H·∫≠u</span></a>
            
            <div class="hidden lg:flex space-x-8 text-[11px] font-bold uppercase tracking-wider text-gray-600 items-center">
                <a href="index.html" class="hover:text-red-900 py-2">Trang Ch·ªß</a>
                <a href="thanh-vien.html" class="text-red-900 py-2 border-b-2 border-red-900">Qu·∫£n L√Ω Check-in</a>
            </div>
            
            <button id="menu-btn" class="lg:hidden text-red-950 p-2"><i class="fa-solid fa-bars text-xl"></i></button>
        </div>
        <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-gray-100 px-4 py-4">
            <a href="index.html" class="block py-2 text-xs font-bold uppercase text-gray-600">Trang Ch·ªß</a>
            <a href="thanh-vien.html" class="block py-2 text-xs font-bold uppercase text-red-900">Qu·∫£n L√Ω</a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 min-h-[80vh]">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black text-red-950 uppercase mb-2">H·ªá Th·ªëng Nh√¢n Vi√™n</h1>
            <p class="text-gray-500 text-sm">Check-in t√≠ch ƒëi·ªÉm & ƒê·ªïi qu√† cho kh√°ch h√†ng</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl mx-auto">

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-fit">
                <div class="flex items-center gap-3 mb-5 border-b border-red-100 pb-3">
                    <div class="w-10 h-10 rounded-full bg-red-900 flex items-center justify-center text-white shadow-md">
                        <i class="fa-solid fa-user-plus"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-red-950 uppercase leading-none">Kh√°ch Mua H√†ng</h3>
                        <span class="text-[10px] text-gray-400">T·∫°o voucher m·ªõi (HSD 48h)</span>
                    </div>
                </div>

                <form id="member-form" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1 block mb-1">S·ªë ƒëi·ªán tho·∫°i kh√°ch</label>
                        <input type="tel" id="phone-input" required pattern="[0-9]{10}"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-red-900 font-bold text-lg text-red-900 placeholder-gray-400 transition"
                            placeholder="09xx xxx xxx">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1 block mb-1">T√™n kh√°ch (N·∫øu c√≥)</label>
                        <input type="text" id="name-input"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-red-900 text-sm transition"
                            placeholder="Nh·∫≠p t√™n...">
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full bg-red-900 text-white font-bold uppercase py-3 rounded-lg hover:bg-black transition shadow-lg flex justify-center items-center gap-2 mt-2">
                        <span>L∆∞u & T·∫°o Voucher</span> <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>

                <div id="form-status" class="mt-4 hidden animate-popup"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-fit">
                <div class="flex items-center gap-3 mb-5 border-b border-yellow-100 pb-3">
                    <div class="w-10 h-10 rounded-full bg-yellow-600 flex items-center justify-center text-white shadow-md">
                        <i class="fa-solid fa-qrcode"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-red-950 uppercase leading-none">Qu√©t M√£ QR</h3>
                        <span class="text-[10px] text-gray-400">D√πng khi kh√°ch ƒë∆∞a m√£ v√©</span>
                    </div>
                </div>

                <div class="relative bg-black rounded-lg overflow-hidden mb-4 min-h-[250px] flex flex-col justify-center border-2 border-gray-800">
                    <div id="reader" class="w-full h-full"></div>
                    <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 z-0 bg-gray-100">
                        <i class="fa-solid fa-camera text-5xl mb-3 text-gray-300"></i> 
                        <span class="text-xs uppercase font-bold tracking-widest">Camera ƒëang t·∫Øt</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button id="start-scan" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg text-sm uppercase transition shadow">
                        <i class="fa-solid fa-power-off mr-1"></i> B·∫≠t Camera
                    </button>
                    <button id="stop-scan" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg text-sm uppercase transition" disabled>
                        T·∫Øt
                    </button>
                </div>
            </div>

            <div class="md:col-span-2 bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-100 mt-4">
                <div class="flex items-center gap-3 mb-5 border-b border-blue-200 pb-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shadow-md">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-blue-900 uppercase leading-none">Tra C·ª©u & ƒê·ªïi Qu√†</h3>
                        <span class="text-[10px] text-gray-500">Nh·∫≠p SƒêT ho·∫∑c M√£ Voucher ƒë·ªÉ ki·ªÉm tra</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="search-input"
                        class="flex-1 bg-white border border-blue-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 font-bold text-lg text-blue-900 placeholder-blue-300"
                        placeholder="Nh·∫≠p M√£ (SH...) ho·∫∑c SƒêT...">
                    <button id="btn-search"
                        class="bg-blue-600 text-white font-bold uppercase px-8 py-3 rounded-lg hover:bg-blue-700 transition shadow-lg whitespace-nowrap flex items-center justify-center gap-2">
                        <i class="fa-solid fa-search"></i> Ki·ªÉm tra
                    </button>
                </div>

                <div id="search-result" class="hidden"></div>
            </div>

        </div>
    </main>

    <footer class="bg-white border-t border-gray-100 mt-10 py-6 text-center">
        <p class="text-[10px] text-gray-400 uppercase tracking-widest">¬© 2025 System by COFFEE S√¥ng H·∫≠u</p>
    </footer>

    <script>
        // ==========================================
        // ‚ö†Ô∏è LINK BACKEND GOOGLE SCRIPT (Update m·ªõi nh·∫•t)
        // ==========================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5hfZcWLIB55y7DoI7mPvWzHGaev3hv-e1FTFmDMafBZSH8nDWvS2RXo2JIO9AWN0Zpw/exec'; 

        // ------------------------------------------
        // 1. LOGIC CHECK-IN & T·∫†O LINK VOUCHER
        // ------------------------------------------
        const form = document.getElementById('member-form');
        const statusDiv = document.getElementById('form-status');
        const submitBtn = document.getElementById('submit-btn');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const phone = document.getElementById('phone-input').value;
            const name = document.getElementById('name-input').value || 'Kh√°ch h√†ng';

            // UI Loading
            submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            submitBtn.disabled = true;
            statusDiv.classList.add('hidden');

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ phone: phone, name: name, type: 'PHONE_CHECKIN' })
            })
            .then(response => response.json()) 
            .then(data => {
                if(data.status === 'success') {
                    // --- T·∫†O LINK G·ª¨I KH√ÅCH ---
                    // T·ª± ƒë·ªông l·∫•y t√™n mi·ªÅn hi·ªán t·∫°i ƒë·ªÉ t·∫°o link
                    // V√≠ d·ª•: yoursite.com/kiem-tra-ve.html?id=SH12345
                    const ticketLink = `${window.location.origin}/thanhvien/kiem-tra-ve.html?id=${data.id}`;
                    
                    // N·ªôi dung tin nh·∫Øn Zalo
                    const msgContent = `‚òï COFFEE S√¥ng H·∫≠u g·ª≠i b·∫°n Voucher!\n\nüëâ B·∫•m v√†o link ƒë·ªÉ l·∫•y m√£ QR:\n${ticketLink}\n\n(H·∫°n s·ª≠ d·ª•ng: 48h)`;

                    statusDiv.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="bg-green-100 p-2 rounded-full text-green-600"><i class="fa-solid fa-check"></i></div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase font-bold">ƒê√£ t·∫°o m√£ th√†nh c√¥ng</p>
                                    <p class="text-xl font-black text-red-800 font-mono tracking-wider">${data.id}</p>
                                </div>
                            </div>
                            
                            <button onclick="sendZalo('${phone}', \`${msgContent}\`)" class="w-full bg-[#0088FF] hover:bg-[#0077ee] text-white text-xs font-bold py-3 px-4 rounded flex items-center justify-center gap-2 transition shadow uppercase">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1200px-Icon_of_Zalo.svg.png" class="w-4 h-4 bg-white rounded-full p-0.5">
                                G·ª≠i Link qua Zalo
                            </button>
                            <p class="text-[10px] text-gray-400 mt-2 text-center italic">B·∫•m n√∫t tr√™n r·ªìi Paste (D√°n) v√†o Zalo kh√°ch.</p>
                        </div>`;
                } else {
                    throw new Error('L·ªói Server');
                }
                statusDiv.classList.remove('hidden');
                form.reset();
            })
            .catch(err => {
                // X·ª≠ l√Ω khi d√πng no-cors (kh√¥ng nh·∫≠n ƒë∆∞·ª£c JSON tr·∫£ v·ªÅ nh∆∞ng request v·∫´n ƒëi)
                // Ta gi·∫£ ƒë·ªãnh th√†nh c√¥ng ƒë·ªÉ b√°o nh√¢n vi√™n
                statusDiv.innerHTML = `<div class="p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200 text-sm"><i class="fa-solid fa-info-circle"></i> ƒê√£ g·ª≠i y√™u c·∫ßu! N·∫øu kh√¥ng th·∫•y m√£ hi·ªán ra, vui l√≤ng tra c·ª©u l·∫°i b·∫±ng SƒêT.</div>`;
                statusDiv.classList.remove('hidden');
            })
            .finally(() => {
                submitBtn.innerHTML = '<span>L∆∞u & T·∫°o Voucher</span> <i class="fa-solid fa-paper-plane"></i>';
                submitBtn.disabled = false;
            });
        });

        // ------------------------------------------
        // 2. LOGIC TRA C·ª®U & HI·ªÇN TH·ªä DANH S√ÅCH VOUCHER
        // ------------------------------------------
        const searchBtn = document.getElementById('btn-search');
        const searchInput = document.getElementById('search-input');
        const resultDiv = document.getElementById('search-result');

        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (!query) { alert('Vui l√≤ng nh·∫≠p SƒêT ho·∫∑c M√£ SH!'); return; }
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="text-center py-10 text-blue-600"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i><p class="text-xs font-bold mt-2 uppercase">ƒêang t√¨m d·ªØ li·ªáu...</p></div>';

            fetch(`${GOOGLE_SCRIPT_URL}?action=search&query=${query}`)
                .then(response => response.json())
                .then(data => {
                    
                    // CASE A: T√åM TH·∫§Y DANH S√ÅCH VOUCHER KH·∫¢ D·ª§NG
                    if (data.status === 'success') {
                        const listVouchers = data.vouchers; // M·∫£ng ch·ª©a c√°c voucher
                        
                        // T·∫°o HTML cho t·ª´ng th·∫ª Voucher
                        let vouchersHTML = listVouchers.map((v, index) => `
                            <div class="voucher-card bg-white border border-gray-200 rounded-lg p-4 mb-3 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 bg-green-600 text-white text-[10px] px-3 py-1 font-bold rounded-bl-lg shadow-sm">
                                    V√© #${index + 1}
                                </div>
                                
                                <div class="flex justify-between items-center mb-4 mt-1">
                                    <div>
                                        <p class="text-[10px] text-gray-400 uppercase font-bold">M√£ Voucher</p>
                                        <p class="font-mono font-black text-xl text-red-700 tracking-wider">${v.id}</p>
                                    </div>
                                    <div class="text-right mr-8">
                                        <p class="text-[10px] text-gray-400 uppercase font-bold">H·∫øt h·∫°n l√∫c</p>
                                        <p class="font-bold text-sm text-black bg-gray-100 px-2 py-0.5 rounded">${v.expire}</p>
                                    </div>
                                </div>
                                
                                <button onclick="redeemGift('${v.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded text-xs uppercase transition shadow flex justify-center items-center gap-2">
                                    <i class="fa-solid fa-ticket"></i> S·ª≠ d·ª•ng v√© n√†y ngay
                                </button>
                            </div>
                        `).join('');

                        resultDiv.innerHTML = `
                            <div class="bg-blue-50 border-l-4 border-blue-500 shadow-md rounded-r-lg p-5 animate-popup">
                                <div class="flex justify-between items-end border-b border-blue-200 pb-3 mb-4">
                                    <div>
                                        <p class="text-xs text-blue-400 uppercase font-bold">Kh√°ch h√†ng</p>
                                        <h4 class="font-black text-xl text-blue-900">${data.name}</h4>
                                    </div>
                                    <div class="text-right">
                                        <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${data.count} v√© kh·∫£ d·ª•ng</span>
                                    </div>
                                </div>
                                
                                <div class="max-h-[400px] overflow-y-auto pr-1 custom-scrollbar">
                                    ${vouchersHTML}
                                </div>
                            </div>`;
                        return;
                    }

                    // CASE B: VOUCHER H·∫æT H·∫†N
                    if (data.status === 'expired') {
                        resultDiv.innerHTML = `
                            <div class="bg-gray-100 border-l-4 border-gray-500 p-6 rounded-r-lg text-center opacity-75">
                                <i class="fa-solid fa-hourglass-end text-4xl text-gray-400 mb-2"></i>
                                <h3 class="text-lg font-black text-gray-600 uppercase">Voucher ƒê√£ H·∫øt H·∫°n</h3>
                                <p class="text-sm text-gray-500 mt-1">M√£ n√†y ƒë√£ qu√° h·∫°n 48 gi·ªù k·ªÉ t·ª´ l√∫c t·∫°o.</p>
                                <p class="text-xs mt-3 border-t border-gray-300 pt-2 text-gray-400">Ng√†y t·∫°o: ${data.createdTime}</p>
                            </div>`;
                    } 
                    // CASE C: VOUCHER ƒê√É D√ôNG
                    else if (data.status === 'used') {
                        resultDiv.innerHTML = `
                            <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-lg text-center shadow-sm">
                                <i class="fa-solid fa-circle-xmark text-4xl text-red-500 mb-2"></i>
                                <h3 class="text-lg font-black text-red-900 uppercase">Voucher Kh√¥ng H·ª£p L·ªá</h3>
                                <p class="text-sm text-red-600 font-bold mt-1">ƒê√£ s·ª≠ d·ª•ng l√∫c: ${data.usedAt}</p>
                            </div>`;
                    } 
                    // CASE D: KH√îNG T√åM TH·∫§Y
                    else {
                        resultDiv.innerHTML = `
                            <div class="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                                <i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-2"></i>
                                <p class="text-gray-500 font-bold text-sm">Kh√¥ng t√¨m th·∫•y voucher n√†o kh·∫£ d·ª•ng.</p>
                            </div>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    resultDiv.innerHTML = `<div class="text-center text-red-600 py-4 font-bold text-sm"><i class="fa-solid fa-wifi"></i> L·ªói k·∫øt n·ªëi Server!</div>`;
                });
        });

        // ------------------------------------------
        // 3. H√ÄM G·ª¨I ZALO (Copy & Open Link)
        // ------------------------------------------
        function sendZalo(phone, content) {
            navigator.clipboard.writeText(content).then(() => {
                let zaloPhone = phone;
                if (zaloPhone.startsWith('0')) zaloPhone = '84' + zaloPhone.substring(1);

                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const zaloLink = `https://zalo.me/${zaloPhone}`;
                
                if (isMobile) {
                    window.location.href = zaloLink;
                } else {
                    window.open(zaloLink, '_blank');
                }
                alert('‚úÖ ƒê√£ COPY Link Voucher!\nZalo s·∫Ω m·ªü ngay b√¢y gi·ªù, b·∫°n h√£y nh·∫•n PASTE (D√°n) ƒë·ªÉ g·ª≠i cho kh√°ch.');
            }).catch(() => alert('L·ªói copy t·ª± ƒë·ªông. Vui l√≤ng copy th·ªß c√¥ng.'));
        }

        // ------------------------------------------
        // 4. H√ÄM ƒê·ªîI QU√Ä (REDEEM) - X·ª≠ l√Ω t·ª´ng v√©
        // ------------------------------------------
        window.redeemGift = function(targetId) {
            if(!confirm(`‚ö†Ô∏è X√ÅC NH·∫¨N S·ª¨ D·ª§NG?\n\nM√£ Voucher: ${targetId}\n\nV√© n√†y s·∫Ω b·ªã KH√ìA vƒ©nh vi·ªÖn sau khi b·∫•m OK.`)) return;
            
            // Kh√≥a t·∫°m giao di·ªán
            const allBtns = document.querySelectorAll('button');
            allBtns.forEach(b => b.disabled = true);
            document.body.style.cursor = 'wait';

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                // G·ª≠i ƒë√∫ng m√£ ID c·ªßa v√© c·∫ßn ƒë·ªïi
                body: JSON.stringify({ phone: targetId, type: 'REDEEM' })
            }).then(() => {
                alert('‚úÖ TH√ÄNH C√îNG!\nVoucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.');
                // Refresh l·∫°i k·∫øt qu·∫£ t√¨m ki·∫øm ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch (x√≥a v√© v·ª´a d√πng)
                document.body.style.cursor = 'default';
                allBtns.forEach(b => b.disabled = false);
                document.getElementById('btn-search').click(); 
            }).catch(err => {
                alert('‚ùå L·ªói k·∫øt n·ªëi!');
                document.body.style.cursor = 'default';
                allBtns.forEach(b => b.disabled = false);
            });
        }

        // ------------------------------------------
        // 5. CAMERA SCANNER
        // ------------------------------------------
        let html5QrcodeScanner = null;
        const startScanBtn = document.getElementById('start-scan');
        const stopScanBtn = document.getElementById('stop-scan');
        const placeholder = document.getElementById('camera-placeholder');

        startScanBtn.addEventListener('click', () => {
            placeholder.style.display = 'none';
            startScanBtn.disabled = true; stopScanBtn.disabled = false;
            
            html5QrcodeScanner = new Html5Qrcode("reader");
            // C·∫•u h√¨nh: ∆Øu ti√™n cam sau, v√πng qu√©t vu√¥ng v·ª©c
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config,
                (decodedText) => {
                    // Khi qu√©t ƒë∆∞·ª£c: T·∫Øt cam -> ƒêi·ªÅn v√†o √¥ t√¨m ki·∫øm -> B·∫•m t√¨m
                    stopScanning();
                    searchInput.value = decodedText; 
                    document.getElementById('btn-search').click();
                })
                .catch((err) => { 
                    console.log(err);
                    alert("Kh√¥ng th·ªÉ m·ªü Camera. Vui l√≤ng c·∫•p quy·ªÅn!"); 
                    stopScanning();
                });
        });

        stopScanBtn.addEventListener('click', stopScanning);

        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear(); 
                    placeholder.style.display = 'flex';
                    startScanBtn.disabled = false; 
                    stopScanBtn.disabled = true;
                }).catch(err => console.log('Stop failed', err));
            }
        }

        // Mobile Menu Toggle
        document.getElementById('menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    </script>
</body>
</html>