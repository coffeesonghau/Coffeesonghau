<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√†nh Vi√™n | COFFEE S√¥ng H·∫≠u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="./style.css" rel="stylesheet"> 

    <style>
        #reader { width: 100%; border-radius: 8px; overflow: hidden; border: 2px solid #7a0b0b; }
        #reader video { object-fit: cover; border-radius: 8px; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #333; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #333, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #333, .5em 0 0 #333; }
        }
    </style>
</head>

<body class="bg-[#fcfcfc] text-gray-900">

    <header class="bg-white sticky top-0 z-50 shadow-sm">
        <div class="bg-red-950 text-white text-[10px] py-2 px-8 flex justify-between uppercase font-bold tracking-widest">
            <span>Coffee S√¥ng H·∫≠u</span><span>Hotline: 0852.494.694</span>
        </div>
        <div class="container mx-auto px-4 py-4 flex justify-between items-center relative">
            <a href="index.html" class="text-2xl font-black text-red-950">COFFEE<span class="text-yellow-600"> S√¥ng H·∫≠u</span></a>
            <div class="hidden lg:flex space-x-8 text-[11px] font-bold uppercase tracking-wider text-gray-600 items-center h-full">
                <a href="index.html" class="hover:text-red-900 py-4">Trang Ch·ªß</a>
                <a href="sanpham.html" class="hover:text-red-900 py-4">S·∫£n ph·∫©m</a>
                <a href="thanh-vien.html" class="text-red-900 py-4 border-b-2 border-red-900">Th√†nh Vi√™n</a>
            </div>
            <div class="flex items-center space-x-4">
                <button id="menu-btn" class="lg:hidden text-red-950 p-2"><i class="fa-solid fa-bars text-2xl"></i></button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-gray-100 px-4 py-6">
            <div class="flex flex-col space-y-2 text-[11px] font-bold uppercase tracking-wider text-gray-600">
                <a href="index.html" class="py-2 border-b border-gray-50 hover:text-red-900">Trang Ch·ªß</a>
                <a href="thanh-vien.html" class="py-2 border-b border-gray-50 text-red-900">Th√†nh Vi√™n</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-10 min-h-[60vh]">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black text-red-950 uppercase mb-2">H·ªá Th·ªëng Th√†nh Vi√™n</h1>
            <p class="text-gray-500">Mua 1 G√≥i Cafe = 1 Voucher (HSD 48h)</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-fit">
                <div class="flex items-center gap-3 mb-4 border-b border-red-100 pb-3">
                    <div class="w-8 h-8 rounded-full bg-red-900 flex items-center justify-center text-white"><i class="fa-solid fa-user-check"></i></div>
                    <h3 class="font-bold text-lg text-red-950 uppercase">T·∫°o Voucher M·ªõi</h3>
                </div>
                <form id="member-form" class="space-y-4">
                    <div>
                        <input type="tel" id="phone-input" required pattern="[0-9]{10}"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-red-900 font-bold text-lg text-red-900 placeholder-gray-400"
                            placeholder="Nh·∫≠p SƒêT kh√°ch (09xxxx)...">
                    </div>
                    <div>
                        <input type="text" id="name-input"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:border-red-900 text-sm"
                            placeholder="T√™n kh√°ch (T√πy ch·ªçn)">
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full bg-red-900 text-white font-bold uppercase py-3 rounded-lg hover:bg-black transition shadow-lg flex justify-center items-center gap-2">
                        <span>L∆∞u & T·∫°o M√£</span> <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
                <div id="form-status" class="mt-4 text-center hidden"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-fit">
                <div class="flex items-center gap-3 mb-4 border-b border-yellow-100 pb-3">
                    <div class="w-8 h-8 rounded-full bg-yellow-600 flex items-center justify-center text-white"><i class="fa-solid fa-qrcode"></i></div>
                    <h3 class="font-bold text-lg text-red-950 uppercase">Qu√©t QR Code</h3>
                </div>
                <div class="relative bg-black rounded-lg overflow-hidden mb-4 min-h-[200px] flex flex-col justify-center">
                    <div id="reader"></div>
                    <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0">
                        <i class="fa-solid fa-camera text-4xl mb-2"></i> <span class="text-xs uppercase">Camera t·∫Øt</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="start-scan" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm uppercase transition">B·∫≠t Cam</button>
                    <button id="stop-scan" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm uppercase transition" disabled>T·∫Øt</button>
                </div>
            </div>

            <div class="md:col-span-2 bg-blue-50 p-6 rounded-xl shadow-inner border border-blue-100">
                <div class="flex items-center gap-3 mb-4 border-b border-blue-200 pb-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white"><i class="fa-solid fa-magnifying-glass"></i></div>
                    <h3 class="font-bold text-lg text-blue-900 uppercase">Tra C·ª©u & ƒê·ªïi Voucher</h3>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="search-input"
                        class="flex-1 bg-white border border-blue-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-600 font-bold text-lg text-blue-900"
                        placeholder="Nh·∫≠p M√£ (SH...) ho·∫∑c SƒêT...">
                    <button id="btn-search"
                        class="bg-blue-600 text-white font-bold uppercase px-8 py-3 rounded-lg hover:bg-blue-700 transition shadow-lg whitespace-nowrap">
                        Ki·ªÉm tra
                    </button>
                </div>

                <div id="search-result" class="mt-6 hidden"></div>
            </div>

        </div>
    </main>

    <footer class="bg-red-950 text-white mt-10 pt-8 pb-8 text-center">
        <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em]"> ¬© 2025 COFFEE S√¥ng H·∫≠u.</p>
    </footer>

    <script>
        // ==========================================
        // ‚ö†Ô∏è THAY LINK APP SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        // ==========================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5hfZcWLIB55y7DoI7mPvWzHGaev3hv-e1FTFmDMafBZSH8nDWvS2RXo2JIO9AWN0Zpw/exec'; 
        
        // ------------------------------------------
        // 1. LOGIC CHECK-IN & T·∫†O VOUCHER QR
        // ------------------------------------------
        const form = document.getElementById('member-form');
        const statusDiv = document.getElementById('form-status');
        const submitBtn = document.getElementById('submit-btn');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const phone = document.getElementById('phone-input').value;
            const name = document.getElementById('name-input').value || 'Kh√°ch v√£ng lai';

            submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang t·∫°o m√£...';
            submitBtn.disabled = true;

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: phone, name: name, type: 'PHONE_CHECKIN' })
            })
            .then(response => response.json()) 
            .then(data => {
                if(data.status === 'success') {
                    // --- T·∫†O QR & N√öT G·ª¨I ZALO ---
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${data.id}`;
                    
                    // T√≠nh gi·ªù h·∫øt h·∫°n (Gi·∫£ l·∫≠p frontend + 48h)
                    const now = new Date();
                    now.setHours(now.getHours() + 48);
                    const expireString = now.toLocaleString('vi-VN', { hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
                    
                    // N·ªôi dung tin nh·∫Øn Copy
                    const msgContent = `‚òï COFFEE S√¥ng H·∫≠u t·∫∑ng b·∫°n!\nüé´ M√£ Voucher: ${data.id}\n‚è∞ H·∫°n d√πng: ${expireString}\n(Vui l√≤ng ƒë∆∞a tin nh·∫Øn n√†y cho nh√¢n vi√™n ƒë·ªÉ qu√©t m√£)`;

                    statusDiv.innerHTML = `
                        <div class="p-4 bg-white border-2 border-dashed border-red-900 rounded-lg shadow-lg relative mt-4">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-red-900 text-white px-3 py-1 text-xs font-bold uppercase rounded shadow">Voucher M·ªõi</div>
                            
                            <div class="flex flex-row items-center gap-4 mt-2">
                                <img src="${qrUrl}" alt="QR Code" class="w-24 h-24 border border-gray-200 p-1 rounded">
                                <div class="text-left flex-1">
                                    <div class="font-mono text-xl font-black text-red-600 tracking-wider mb-1">${data.id}</div>
                                    <p class="text-xs text-gray-500">H·∫øt h·∫°n: <span class="font-bold text-black">${expireString}</span></p>
                                </div>
                            </div>

                            <div class="mt-3 grid grid-cols-1 gap-2">
                                <button onclick="sendZalo('${phone}', \`${msgContent}\`)" class="bg-blue-600 hover:bg-blue-700 text-white text-[11px] font-bold py-3 px-4 rounded flex items-center justify-center gap-2 transition uppercase">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1200px-Icon_of_Zalo.svg.png" class="w-5 h-5 bg-white rounded-full p-0.5">
                                    Copy & M·ªü Zalo Kh√°ch
                                </button>
                            </div>
                        </div>`;
                } else {
                    throw new Error('L·ªói Server');
                }
                statusDiv.classList.remove('hidden');
                form.reset();
            })
            .catch(err => {
                // D·ª± ph√≤ng l·ªói JSON (no-cors)
                statusDiv.innerHTML = `<div class="p-4 bg-green-100 text-green-800 rounded">‚úÖ ƒê√£ l∆∞u! (Kh√¥ng th·ªÉ l·∫•y m√£ ID do l·ªói m·∫°ng, h√£y tra c·ª©u b·∫±ng SƒêT).</div>`;
                statusDiv.classList.remove('hidden');
            })
            .finally(() => {
                submitBtn.innerHTML = '<span>L∆∞u & T·∫°o M√£</span> <i class="fa-solid fa-paper-plane"></i>';
                submitBtn.disabled = false;
            });
        });

        // ------------------------------------------
        // 2. LOGIC TRA C·ª®U (C·∫¨P NH·∫¨T: HI·ªÇN TH·ªä DANH S√ÅCH VOUCHER)
        // ------------------------------------------
        const searchBtn = document.getElementById('btn-search');
        const searchInput = document.getElementById('search-input');
        const resultDiv = document.getElementById('search-result');

        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (!query) { alert('Vui l√≤ng nh·∫≠p SƒêT ho·∫∑c M√£ SH!'); return; }
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="text-center py-8 text-blue-800 font-bold loading-dots text-lg">ƒêang k·∫øt n·ªëi h·ªá th·ªëng...</div>';

            fetch(`${GOOGLE_SCRIPT_URL}?action=search&query=${query}`)
                .then(response => response.json())
                .then(data => {
                    
                    // A. T√åM TH·∫§Y DANH S√ÅCH VOUCHER KH·∫¢ D·ª§NG
                    if (data.status === 'success') {
                        const listVouchers = data.vouchers; // Nh·∫≠n m·∫£ng voucher t·ª´ Server
                        
                        // V·∫Ω t·ª´ng th·∫ª Voucher
                        let vouchersHTML = listVouchers.map((v, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 shadow-sm relative overflow-hidden group hover:border-blue-500 transition">
                                <div class="absolute top-0 right-0 bg-green-600 text-white text-[10px] px-3 py-1 font-bold rounded-bl-lg">V√© ${index + 1}</div>
                                
                                <div class="flex justify-between items-center mb-3">
                                    <div>
                                        <p class="text-[10px] text-gray-500 uppercase font-bold">M√£ Voucher</p>
                                        <p class="font-mono font-black text-xl text-red-800 tracking-wider">${v.id}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[10px] text-gray-500 uppercase font-bold">H·∫øt h·∫°n l√∫c</p>
                                        <p class="font-bold text-sm text-black">${v.expire}</p>
                                    </div>
                                </div>
                                
                                <button onclick="redeemGift('${v.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded text-sm uppercase transition shadow-md flex justify-center items-center gap-2">
                                    <i class="fa-solid fa-ticket"></i> S·ª≠ d·ª•ng v√© n√†y
                                </button>
                            </div>
                        `).join('');

                        resultDiv.innerHTML = `
                            <div class="bg-blue-50 border-l-4 border-blue-500 shadow-lg rounded-r-lg p-5">
                                <div class="flex justify-between items-end border-b border-blue-200 pb-3 mb-4">
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase font-bold">Kh√°ch h√†ng</p>
                                        <h4 class="font-black text-xl text-gray-800">${data.name}</h4>
                                    </div>
                                    <div class="text-right">
                                        <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">${data.count} v√© kh·∫£ d·ª•ng</span>
                                    </div>
                                </div>
                                
                                <div class="max-h-[400px] overflow-y-auto pr-1">
                                    ${vouchersHTML}
                                </div>
                            </div>`;
                        return;
                    }

                    // B. C√ÅC TR∆Ø·ªúNG H·ª¢P L·ªñI / H·∫æT H·∫†N
                    if (data.status === 'expired') {
                        resultDiv.innerHTML = `
                            <div class="bg-gray-100 border-l-8 border-gray-500 p-6 rounded-r-lg text-center opacity-80">
                                <div class="text-6xl text-gray-400 mb-4"><i class="fa-solid fa-hourglass-end"></i></div>
                                <h3 class="text-2xl font-black text-gray-600 uppercase mb-2">VOUCHER ƒê√É H·∫æT H·∫†N</h3>
                                <p class="text-gray-500 font-bold">M√£ n√†y ƒë√£ qu√° h·∫°n 48 gi·ªù.</p>
                                <p class="text-xs mt-2 text-gray-400">Ng√†y t·∫°o: ${data.createdTime}</p>
                            </div>`;
                    } else if (data.status === 'used') {
                        resultDiv.innerHTML = `
                            <div class="bg-red-50 border-l-8 border-red-500 p-6 rounded-r-lg text-center shadow-xl">
                                <div class="text-6xl text-red-500 mb-4"><i class="fa-solid fa-circle-xmark"></i></div>
                                <h3 class="text-2xl font-black text-red-900 uppercase mb-2">VOUCHER KH√îNG H·ª¢P L·ªÜ</h3>
                                <p class="text-red-600 font-bold border-t border-red-200 pt-2">ƒê√£ s·ª≠ d·ª•ng l√∫c: ${data.usedAt}</p>
                            </div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="text-center text-gray-500 font-bold py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y voucher kh·∫£ d·ª•ng!</div>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    resultDiv.innerHTML = `<div class="text-center text-red-600 py-4">L·ªói k·∫øt n·ªëi Server!</div>`;
                });
        });

        // ------------------------------------------
        // 3. H√ÄM G·ª¨I ZALO (Copy & Open)
        // ------------------------------------------
        function sendZalo(phone, content) {
            navigator.clipboard.writeText(content).then(() => {
                let zaloPhone = phone;
                if (zaloPhone.startsWith('0')) zaloPhone = '84' + zaloPhone.substring(1);

                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    window.location.href = `https://zalo.me/${zaloPhone}`;
                } else {
                    window.open(`https://zalo.me/${zaloPhone}`, '_blank');
                }
                alert('‚úÖ ƒê√£ COPY n·ªôi dung!\nZalo s·∫Ω m·ªü ngay b√¢y gi·ªù, b·∫°n h√£y nh·∫•n PASTE (D√°n) ƒë·ªÉ g·ª≠i.');
            }).catch(() => alert('L·ªói copy. H√£y ch·ª•p m√†n h√¨nh g·ª≠i kh√°ch.'));
        }

        // ------------------------------------------
        // 4. C√ÅC H√ÄM KH√ÅC (Redeem, Scanner, Menu)
        // ------------------------------------------
        window.redeemGift = function(inputKey) {
            if(!confirm(`‚ö†Ô∏è X√°c nh·∫≠n s·ª≠ d·ª•ng Voucher: ${inputKey}?\nM√£ s·∫Ω b·ªã KH√ìA ngay sau khi b·∫•m OK.`)) return;
            
            // T√¨m n√∫t b·∫•m t∆∞∆°ng ·ª©ng ƒë·ªÉ hi·ªán tr·∫°ng th√°i Loading
            const allBtns = document.querySelectorAll('button');
            allBtns.forEach(b => b.disabled = true); // Kh√≥a t·∫°m t·∫•t c·∫£ n√∫t

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: inputKey, type: 'REDEEM' })
            }).then(() => {
                alert('‚úÖ TH√ÄNH C√îNG!\nVoucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.');
                // Refresh l·∫°i k·∫øt qu·∫£ t√¨m ki·∫øm ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
                document.getElementById('btn-search').disabled = false;
                document.getElementById('btn-search').click(); 
            }).catch(err => {
                alert('‚ùå L·ªói k·∫øt n·ªëi!');
                allBtns.forEach(b => b.disabled = false);
            });
        }

        let html5QrcodeScanner = null;
        const startScanBtn = document.getElementById('start-scan');
        const stopScanBtn = document.getElementById('stop-scan');
        const placeholder = document.getElementById('camera-placeholder');

        startScanBtn.addEventListener('click', () => {
            placeholder.style.display = 'none';
            startScanBtn.disabled = true; stopScanBtn.disabled = false;
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    searchInput.value = decodedText; searchBtn.click(); stopScanning();
                }).catch(() => { stopScanning(); alert("L·ªói Camera!"); });
        });

        stopScanBtn.addEventListener('click', stopScanning);

        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear(); placeholder.style.display = 'flex';
                    startScanBtn.disabled = false; stopScanBtn.disabled = true;
                });
            }
        }

        document.getElementById('menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    </script>
</body>
</html>